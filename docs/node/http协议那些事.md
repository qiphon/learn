# http 协议

- 当我们输入网址后发生了什么
    
    ```
    http 请求模型

    client  -------->   server  --------->  client
            请求（req）           相应(res)
    ```
    1. 输入网址并回车
        - 发送dns包

    2. 解析域名
        - 返回 IP地址

    3. 浏览器发送 http 请求
        - 网关记录请求规则
        - 发出数据包 --> 路由中继 (不定数量) --> server

    4. 服务器处理请求
        - 服务器代理请求，转发到指定位置

    5. 服务器返回（HTML）相应
        - 返回数据包

    6. 浏览器处理（HTML）相应
        - 解析服务器数据包

    7. 继续请求其他资源
        - 

- http 协议详解
    - http是超文本传输协议，从 www 浏览器传输到本地浏览器的一种传输协议，网站是基于 http 协议的
    例如网站的图片、css、js等都是基于 http 协议的
    - http 协议是由 ×客户机到服务器的请求request× 和 ×从服务起到客户机的响应reponse× 进行约束和规范
    
    ```
    http 发展

    http/0.9   ----------  http/1.0  ---------- http/1.1 ---------- http2
    1991                   1996                 1999                2015

    ```
    - TCP/IP 协议栈 （标准 7 层， 实际 5层）

        ```
           标准7层协议                    应用中的5层协议
           --------------------------------------------
               应用层                         应用层
           --------------    
               表示层
           --------------
               会话层
           --------------------------------------------
               传输层                         传输层
           --------------------------------------------
               网络层                         网络层
           --------------------------------------------
              数据链路层                     网络接口层
           ---------------
               物理层
           --------------------------------------------

        ```

        1. 应用层 （应用层、表示层、会话层）
            - 为用户提供所需要的各种服务 ，如 http、ftp、dns、smtp
        2. 传输层（）
            - 该层定义了2个主要的协议：tcp（传输控制协议）、udp（用户数据报协议）
            - 为应用层实体提供端到端的通信功能，保证数据包的顺序传送即数据的完整性
            
        3. 网络层
            - 主要解决主机到主机的通信问题。IP协议是网际互连网层最重要的协议
        
        4. 网络接口层
            - 负责监视数据在主机和网络之间的交换

        - http 在 tcp/ip 协议栈中的位置

        ```
                        http
                            | ssl/tls
            --------------------------
                        tcp
            --------------------------
                        ip
            --------------------------
                     数据链路层

           http 默认端口 80   https 443
        ```

    - http 的工作过程
        - 一次http 操作称为一个事务，其工作可分为 4 步，一旦一个步骤失败，整个事务失败
            1. 客户端与服务器建立连接  tcp 层
            2. 客户机发送一个请求 请求格式（统一资源标识符URL、协议版本号、mime信息）  Http
            3. 服务端处理请求返回响应  http
            4. 显示结果， 客户机与服务器断开连接  tcp
    
    - 请求与响应 
        - http请求组成：请求行（GET /  ）、消息报头、请求正文
        - http响应组成：状态行(HTTP/1.1 200 OK)、消息报头、响应正文
        - 请求行组成：以一个方法符号开头，后面跟着请求的uri 和 协议的版本
        - 状态行组成：服务器http协议的版本，服务器发回的响应状态代码 和 状态代码的文本描述
    
    - 请求
        
        ```
        # 请求

        请求方法           请求URL   http协议及版本
        ----| ------------------|  -------|
        POST /chapter17/user.html  HTTP/1.1
        Accept:
        Referer:
        Accept-Language：                      -------> 报文头
        。。。

        name=1&pwd=2                           ------->报文体
         
        ----------------------------------------------------------------

        
        请求方法 空格 URL 空格 协议版本 回车符换行符    -----> 请求行
        头部字段名：值 回车符换行符                   -----> 请求头
        回车符换行符                            -------> 为了区分头和体
                                                  -----> 请求体

        

        ascii 一个字节代表一个字符  256 个字符

        ```

        - 请求方法（详情可以参考RFC文档）
            - get        请求获取
            - post       在 request-URI 所标识的资源后附加新的数据
            - head       请求获取由 Request-URI所标识的资源的响应消息报头
            - put        请求服务器存储一个资源
            - delete     请求服务器删除
            - trace      请求服务器回送收到的请求信息
            - connect
            - options     请求查询服务器的性能，或者查询与资源相关的选项和需求
            - connect    http/1.1 中预留
        
        - http状态码
            - 1  指示信息  -- 表示请求已接收，继续处理
            - 2  成功     --- 表示请求已被成功接收、理解、接受
            - 3  重定向    -- 要完成请求必须进行更进一步的操作
                - 301 永久重定向 
                - 302 临时重定向 -- 跳转
                - 305 超空间移动  -- 代理
                - 307 临时跳转

            - 4  客户端错误 -- 请求的语法错误或请求无法实现
                - 400 错误请求
                - 402 收费
                - 403 服务器拒绝 
                - 404 找不到
                - 406 请求不接受
                - 408 超时
                - 409 访问冲突
                - 410 资源不见了
                - 413 响应实体过大
                - 417 请求无法满足
                - 418 一个玩笑，茶壶控制协议
                - 420 请求执行失败
                - 422 请求有错误

            - 5  服务端错误 -- 服务器未能实现合法的请求
                - 500 服务器内部错误
        - 请求报头

            ```
            Accept   告诉服务器接受的类型 text/html application/json
            Accept-Encoding  gzip,  是否接受数据压缩
            Accept-Laguage   接受的语言 zh-CN,zh,q=0.9
            Connection    keep-alive (长连接)  
            Host    域名
            Referer  来源，上一个页面是谁，从哪里过来的. 可以用来检查盗链
            User-Agent  浏览器、操作系统信息，用于表明身份
            Cookie

            Content-Encoding    gzip
            Server           服务器使用的是什么
            Cache-Ctrol
            Date
            Expires
            Strict-Transport-Security

            ```
- cookie 与 session
    - cookie 是保存在客户端的一小段文本，随客户端没次请求服务端下发cookie，下次请求浏览器携带cookie到服务器
        - 可以实现免登录
        - 下发  `Set-Cookie: abc=123; path=/; domain=.baidu.com; ` 逐条下发
        - 浏览器端 `document.cookie` 查看修改 cookie
    - session 保存在服务端，由客户端和服务端共同维护
        - 和 cookie 配合使用，保证安全性，更加安全的要和 token 配合（token定时更新）
        - session通过唯一的值 sessionID 来区别每一个用户。sessionID 随每个连接请求发送到服务器
        - 服务器根据 sessionID 来识别客户端，再通过session 的key来获取session 值

- http 缓存 
    - 缓存会根据请求保存输出内容的副本,下一个请求到来的时候，如果是相同的URL，缓存直接使用副本响应
    - 缓存会减少网络延迟，减少带宽消耗
    
    ```
    浏览器请求 --> 无缓存 --> 向web服务器请求 --> 请求响应，协商缓存 --> 显现

    浏览器请求 --> 有缓存 ----------> 是否使用 Etag --------------------------->|
                    |      缓存过期        |        请求携带If-None-Match      |
               没过期|                     |                                 |
                    |             是否使用Last-Modified -------------------->|
                响应缓存                   |         请求携带If-Modified-Since |
                                          |否                                |
                                          |                                 |
                                    请求数据，协商缓存   <-----------------200/304
                                                        无缓存 200           |
                                                                            |
                                                                        304 响应缓存
    

    ```

    - 强制缓存：服务器通知浏览器一个缓存时间，在缓存时间内直接使用缓存内容，超过时间使用比较缓存
    - 比较缓存: 将缓存信息中的Etag 和 Last-Modified 通过请求，发送服务器校验，返回 304 状态码时，直接使用缓存 
        - Etag/if-None-Match (优先)
        - Last-Modified/If-Modified-Since

    - cache-conctrol: max-age=234234  / no-cache
    - expires: 时间对象  （优先级低于 cache-control）
    - pragma : (http1.0产物，现在基本看不到了)
    - 上面是强缓 =============== 下面是比较缓存
    - last-modified / If-Modified-Since （请求时调用）
    - etag / If-None-Match （请求时调用）
    - POST 请求不会被缓存

- 密码学入门
    - 加密就是一种数学算法，涉及到　数论、质数等
    - 密码学的处理对象是 数字 和 字符串
    - 散列是一种数据，一旦转换为其他形式将永远无法回复的加密技术
    - 加密
        - 对称加密　（ＡＥＳ、ＤＥＳ、３ＤＥＳ）加密的秘钥和解密的秘钥相同
        - 非对称加密 （ＲＳＡ）加密的秘钥　（公钥）　和解密　（私钥）　的秘钥不同
    - 秘钥交换算法　（针对的是对称加密）
        - Diffie-Hellman 算法是一种著名的秘钥协商算法，这种算法可以使得信息交换的双方通过公开的非安全的网络
        协商生成安全的共享秘钥
            
            1. Alice 与 Bob 确定2个大素数 n 和 g，

- 证书签发机构 （CA）
    - 通过CA发放的证书完成秘钥的交换，实际上是利用非对称的加密算法完成数据加密秘钥的安全交换，
    然后再用数据加密秘钥完成数据的安全交换
    - 数字证书
    - CA：CA
    - CA的工作流程

        1. 服务器 qiphon.con 将从 CA 请求 TLS 证书， 例如Digicert
        2. Digicert 将为 qiphon.com 创建证书，证书将包含必要的数据，例如 服务器的名称，服务器的公钥等。
        3. Digicert 创建数据（证书）的哈希值，并使用自己的私钥对其加密

    - 浏览器如何验证证书的有效性
        - 证书颁发

- SSL/TLS 协议
    - 传输层安全协议（transport layer security，TSL）及其前身安全套接层（secure sockets layer，SSL）是一种安全协议
    目的是为互联网通信提供安全及数据完整性保障
    - HTTPS 协议的安全性由 SSL 协议实现，当前使用的TLS协议 1.2 版本，包含 4 个核心子协议：握手协议、秘钥配置切换协议、
    应用数据协议及报警协议。

        - TLS适用于对称秘钥

- https 协议分析
    - TLS 握手步骤
        1. client1： 客户端发送所支持的 SSL/TLS 最高协议版本号和所支持的加密算法集合，以及压缩方法集合等信息给服务器。
        2. server：服务器收到信息后，选定双方都支持的 SSL/TLS 协议

        ```
            client                      server
                   1. hello
                ----------------------->
                   2. hello
                <-----------------------
                   3. send certificate
                <----  --- ---  ---  ---
                   4. request certificate
                <---  --  ----  ---  ---
                   5. server done
                <-----------------------
                   6. response certificate
                ---  --  ----  ---  --->
                   7. certificate change
                ----------------------->
                   8. certificate vertify
                ---  --  ----  ---  --->
                   9. 

        ``` 

- http2 协议分析
    - http/2 没有改变 http 的应用语义。http方法、状态代码、uri 和 标头字段等核心概念一如往常
    - http/2 修改了数据格式化（分帧）以及在客户端与服务器间传输的方式。这2点统帅全局，通过新的分帧层向我们的应用隐藏了所有复杂性
    - 由于 http/2 引入了一个新的

- http2 二进制分帧层
    - http/2所有性能增强的核心在于新的二进制分帧层，它定义了如何封装 http 消息，并在客户端与服务端之间通信

- http2 多路复用
    - 在http1.x中，如果客户端想要发起

- 服务器推送
    - 服务器可以对客户端请求发送多个响应。（除了）

- http2 的伪头字段

### http3

- 运行在 QUIC （在udp上封装的协议）之上的 http 协议被称为 http/3 （http-over-QUIC）
- QUIC 协议（quick UDP Internet connection）基于 UDP，正式看中了UDP的速度与效率。
同时 QUIC 也整合了 TCP、TLS 和 HTTP2的优点，并加以优化。
- 特点
    - 减少握手的延迟 （1-RTT 或 0-RRT）
    - 多路复用，没有 TCP 的阻塞问题
    - 连接迁移，由 WiFi 切换到 4G 时，连接不断开
- http3 与 http1.1 和 http2 没有直接的关系，也不是 http2 的扩展
- 


### 队首阻塞问题

- http1.1 和 http2 都存在队首阻塞问题（head of line blocking）
- http1.1 的队首阻塞。一个 tcp 连接同时传输 10个请求，其中第 1,2,3个请求已被客户端接收但是第 4 个丢失，那么第5-10个
请求被阻塞，需要等到第四个请求处理完毕才能被处理，这样就浪费了带宽资源
- http2 的多路复用虽然可以解决“请求”这个粒度的阻塞

### http 与 反向代理

- 什么是代理，什么又是反向代理？

```
# 正向代理
------------------------|
client  ---->           |
              \         |
client  ---->     proxy |  --->  server
              /         |
client  ---->           |
------------------------|
局域网

代理功能
- 代理能够记录行为
- 可以记录网站，减少带宽消耗



# 反向代理
                      局域网
                 |----------------------- 
client  ---->    |          --->  server
               \ |        /
client  ---->    | proxy    --->  server
               / |        \
client  ---->    |          --->  server
                 |------------------------

代理功能（比如工厂的向导，把你的需求指向本地的另一个位置）
- 转发请求
- 负载均衡
- 防止内部服务器被工具
- 缓存静态数据
- 加密和 SSL加速
- 压缩
- 减速上传
- 外网发布

```


